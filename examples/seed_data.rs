use sqlx::{PgPool, postgres::PgPoolOptions};
use timescale_example::{RepositoryRow, WorkflowRunRow, create_repository, create_workflow_run};
use uuid::Uuid;

#[tokio::main]
async fn main() -> Result<(), sqlx::Error> {
    env_logger::Builder::from_env(env_logger::Env::default().default_filter_or("info")).init();

    let pool = PgPoolOptions::new()
        .max_connections(1)
        .connect(&std::env::var("DATABASE_URL").unwrap())
        .await?;

    sqlx::migrate!().run(&pool).await?;

    let (repos, runs) = generate_seed_data(&pool).await?;

    for repo in repos {
        create_repository(repo.id, &repo.name, &repo.org_id, &pool).await?;
    }

    for run in runs {
        create_workflow_run(&run, &pool).await?;
    }

    Ok(())
}

async fn generate_seed_data(
    pool: &PgPool,
) -> Result<(Vec<RepositoryRow>, Vec<WorkflowRunRow>), sqlx::Error> {
    let mut repos = vec![];

    let repo_org_id = [
        (1, "periodic-wing", "9bfeff91-ba3c-4eef-9479-3407a59ded6b"),
        (2, "fascinated-feet", "0a65112c-62df-4f36-a748-f1ba4ef30c3b"),
        (3, "testy-legs", "4a1c33a9-acb5-4f71-8a31-39708835b535"),
        (
            4,
            "testier-legs-cmd",
            "4a1c33a9-acb5-4f71-8a31-39708835b535",
        ),
        (
            5,
            "testier-legs-query",
            "4a1c33a9-acb5-4f71-8a31-39708835b535",
        ),
        (
            6,
            "testier-legs-worker",
            "4a1c33a9-acb5-4f71-8a31-39708835b535",
        ),
    ];

    for (repo_id, name, org_id) in repo_org_id {
        repos.push(RepositoryRow {
            id: repo_id,
            name: name.to_owned(),
            org_id: Uuid::parse_str(org_id).unwrap(),
        });
    }

    // Generate some random seed data using Postgres
    let result = sqlx::query_as::<_, WorkflowRunRow>(
        r#"
      WITH names AS (
        SELECT row_number() OVER () AS rn, name
        FROM UNNEST($1::text[]) AS name
      ),
      series AS (
        SELECT row_number() OVER () AS rn,
          generate_series(
            now() - INTERVAL '1 month',
            now(),
            INTERVAL '5 minutes'
          ) AS time
      )
      SELECT
        s.time,
        floor(random() * 3 + 1)::int AS repository_id,
        make_interval(secs := (random() * 100)::int) AS duration,
        n.name AS workflow_name
      FROM series s
      JOIN names n ON s.rn = n.rn;
    "#,
    )
    .bind(WORKFLOW_NAMES)
    .fetch_all(pool)
    .await
    .expect("should not fail");

    Ok((repos, result))
}

const WORKFLOW_NAMES: [&str; 500] = [
    "cloistered-lip",
    "handy-range",
    "beautiful-zipper",
    "angry-lift",
    "secret-brain",
    "ugly-rake",
    "oval-knot",
    "beautiful-toys",
    "tan-sidewalk",
    "frightened-baby",
    "chivalrous-lettuce",
    "curly-monkey",
    "flagrant-map",
    "impartial-worm",
    "workable-zephyr",
    "absorbed-honey",
    "impolite-self",
    "same-building",
    "supreme-berry",
    "tense-clover",
    "eight-memory",
    "steady-sweater",
    "quaint-gun",
    "clever-clover",
    "white-thread",
    "fearless-guide",
    "cheap-snow",
    "unbecoming-use",
    "windy-passenger",
    "axiomatic-curve",
    "unable-battle",
    "overconfident-root",
    "mean-cream",
    "salty-calendar",
    "raspy-tramp",
    "axiomatic-point",
    "needless-engine",
    "worried-ink",
    "fixed-use",
    "upset-wave",
    "sable-straw",
    "selective-color",
    "level-voice",
    "present-achiever",
    "screeching-stone",
    "shy-man",
    "groovy-calculator",
    "succinct-approval",
    "dazzling-mask",
    "future-lizards",
    "wholesale-news",
    "disagreeable-sun",
    "abandoned-girls",
    "afraid-ducks",
    "responsible-room",
    "sordid-price",
    "maniacal-angle",
    "interesting-vein",
    "dull-achiever",
    "jumpy-lead",
    "certain-birth",
    "gamy-toys",
    "horrible-muscle",
    "waggish-earth",
    "furtive-riddle",
    "square-temper",
    "deeply-deer",
    "simple-rake",
    "meaty-cushion",
    "aboriginal-instrument",
    "fine-vein",
    "deep-galley",
    "numerous-competition",
    "adventurous-destruction",
    "profuse-cause",
    "superb-print",
    "female-string",
    "workable-family",
    "merciful-lizards",
    "previous-run",
    "disgusting-clouds",
    "natural-rabbit",
    "friendly-battle",
    "vague-change",
    "average-worm",
    "heartbreaking-spark",
    "fierce-discussion",
    "dramatic-throne",
    "snotty-hearing",
    "savory-print",
    "best-seat",
    "mundane-planes",
    "big-powder",
    "incredible-toothbrush",
    "magenta-heart",
    "opposite-page",
    "soft-cave",
    "mere-feeling",
    "terrible-ghost",
    "hypnotic-beetle",
    "automatic-society",
    "somber-trees",
    "narrow-note",
    "sulky-religion",
    "furtive-apple",
    "tired-answer",
    "malicious-pleasure",
    "disillusioned-attack",
    "sore-jail",
    "plant-lunch",
    "immense-sheep",
    "plausible-cent",
    "elderly-expansion",
    "nutritious-airport",
    "lively-polish",
    "comfortable-flag",
    "unsuitable-soda",
    "slimy-thrill",
    "teeny-tiny-frogs",
    "shut-tax",
    "elastic-children",
    "righteous-earth",
    "successful-silver",
    "crowded-wilderness",
    "sassy-magic",
    "panoramic-banana",
    "picayune-shade",
    "labored-yarn",
    "unsuitable-eggnog",
    "hulking-song",
    "aquatic-police",
    "minor-honey",
    "dull-nut",
    "thankful-roof",
    "abusive-quince",
    "disastrous-actor",
    "abstracted-birthday",
    "slippery-can",
    "crabby-coal",
    "rhetorical-veil",
    "lavish-transport",
    "undesirable-ear",
    "sad-grain",
    "physical-wheel",
    "bad-peace",
    "condemned-bear",
    "adhesive-yard",
    "hushed-ticket",
    "forgetful-credit",
    "irritating-part",
    "harsh-argument",
    "clumsy-story",
    "numerous-disgust",
    "lonely-waves",
    "gentle-cattle",
    "industrious-disgust",
    "aboriginal-rat",
    "grotesque-branch",
    "encouraging-receipt",
    "shut-science",
    "large-activity",
    "thundering-discovery",
    "past-clam",
    "secretive-ghost",
    "used-star",
    "hysterical-frogs",
    "stereotyped-wilderness",
    "secretive-crime",
    "numerous-hat",
    "tiny-expansion",
    "calm-flesh",
    "intelligent-place",
    "milky-error",
    "handsome-wrench",
    "fanatical-wrist",
    "enchanting-range",
    "unwieldy-pet",
    "scrawny-help",
    "frequent-pump",
    "defeated-grade",
    "simple-oven",
    "thinkable-lettuce",
    "general-afternoon",
    "chemical-breakfast",
    "classy-scent",
    "nervous-governor",
    "possessive-snails",
    "befitting-daughter",
    "milky-bat",
    "disturbed-tub",
    "opposite-kitty",
    "detailed-peace",
    "cowardly-help",
    "black-and-white-move",
    "shocking-vacation",
    "inconclusive-dinosaurs",
    "dizzy-side",
    "aggressive-cry",
    "hateful-event",
    "magical-soda",
    "elegant-disease",
    "moldy-nose",
    "disgusting-grass",
    "clean-hen",
    "flashy-square",
    "determined-soup",
    "scared-minute",
    "sedate-key",
    "hushed-sisters",
    "scarce-property",
    "opposite-geese",
    "drab-apple",
    "overwrought-cracker",
    "pale-kite",
    "scandalous-achieve",
    "jaded-owner",
    "ashamed-geese",
    "ambitious-line",
    "materialistic-brass",
    "toothsome-icicle",
    "vacuous-transport",
    "easy-smoke",
    "squalid-move",
    "obsequious-jam",
    "new-whip",
    "familiar-brothers",
    "thick-nose",
    "caring-dust",
    "wacky-root",
    "dashing-drum",
    "cumbersome-story",
    "furtive-unit",
    "versed-music",
    "ahead-song",
    "grouchy-record",
    "lively-dirt",
    "naive-basin",
    "crazy-achiever",
    "whimsical-friction",
    "apathetic-substance",
    "raspy-color",
    "sturdy-meal",
    "plausible-basketball",
    "living-rat",
    "excellent-limit",
    "delirious-creature",
    "damaging-hen",
    "earsplitting-current",
    "flowery-heart",
    "smooth-start",
    "funny-quill",
    "elfin-scarf",
    "polite-statement",
    "tangy-sense",
    "panicky-competition",
    "ugly-airport",
    "full-neck",
    "odd-planes",
    "soggy-amusement",
    "macho-earthquake",
    "axiomatic-shoe",
    "aberrant-feeling",
    "deep-temper",
    "exultant-hook",
    "innocent-pancake",
    "polite-beginner",
    "symptomatic-bun",
    "frail-clocks",
    "befitting-mouth",
    "verdant-punishment",
    "wet-number",
    "waggish-crowd",
    "comfortable-number",
    "weary-vein",
    "insidious-camera",
    "jealous-parent",
    "tedious-flavor",
    "pathetic-advice",
    "forgetful-nut",
    "half-bubble",
    "lying-idea",
    "malicious-rose",
    "psychedelic-banana",
    "ludicrous-attraction",
    "furry-cap",
    "acoustic-goat",
    "tight-brothers",
    "parallel-letters",
    "unique-boy",
    "diligent-pig",
    "remarkable-debt",
    "wasteful-ice",
    "tender-range",
    "peaceful-partner",
    "blue-park",
    "defeated-fiction",
    "brawny-airplane",
    "murky-lip",
    "nervous-shape",
    "noxious-account",
    "heavenly-bubble",
    "longing-game",
    "eager-cloud",
    "silky-able",
    "wistful-bears",
    "limping-story",
    "abrasive-lock",
    "likeable-engine",
    "powerful-color",
    "meaty-horse",
    "bite-sized-sticks",
    "kaput-veil",
    "long-manager",
    "intelligent-texture",
    "abstracted-cheese",
    "slow-pest",
    "scarce-railway",
    "old-fashioned-quicksand",
    "understood-letters",
    "innocent-cord",
    "envious-smell",
    "seemly-apparel",
    "minor-friends",
    "dangerous-office",
    "purple-calendar",
    "glib-faucet",
    "long-cherries",
    "understood-notebook",
    "dull-discussion",
    "late-pot",
    "resonant-tree",
    "futuristic-religion",
    "parsimonious-alarm",
    "typical-battle",
    "royal-button",
    "good-care",
    "interesting-airport",
    "whole-patch",
    "cool-edge",
    "dysfunctional-lumber",
    "like-babies",
    "nimble-event",
    "pleasant-teeth",
    "half-cook",
    "bawdy-bears",
    "mysterious-faucet",
    "sophisticated-pets",
    "thundering-meal",
    "fabulous-front",
    "utter-yoke",
    "scandalous-shelf",
    "majestic-apparel",
    "miscreant-memory",
    "familiar-dirt",
    "grateful-credit",
    "dead-motion",
    "curved-attraction",
    "glamorous-children",
    "secretive-grade",
    "cumbersome-acoustics",
    "futuristic-brush",
    "sincere-fireman",
    "seemly-room",
    "grey-gold",
    "overjoyed-judge",
    "utter-statement",
    "faulty-copper",
    "fascinated-day",
    "damp-shape",
    "cautious-stove",
    "different-passenger",
    "dashing-crime",
    "questionable-string",
    "gentle-skirt",
    "cut-lead",
    "sweet-news",
    "limping-station",
    "mammoth-railway",
    "able-field",
    "threatening-angle",
    "fluttering-appliance",
    "fretful-way",
    "quack-jump",
    "tiny-nail",
    "bent-winter",
    "oafish-train",
    "elfin-behavior",
    "tough-garden",
    "weak-sister",
    "unknown-way",
    "determined-galley",
    "spotty-blade",
    "flowery-fire",
    "absorbed-calendar",
    "curved-record",
    "lazy-scarf",
    "accessible-crime",
    "scared-riddle",
    "violent-attention",
    "absorbed-treatment",
    "grubby-wealth",
    "magnificent-room",
    "late-line",
    "numerous-rail",
    "unused-jellyfish",
    "present-existence",
    "jumbled-company",
    "irritating-name",
    "ossified-ice",
    "melodic-canvas",
    "present-agreement",
    "curved-day",
    "cut-songs",
    "berserk-snakes",
    "sad-plot",
    "accurate-visitor",
    "fine-chicken",
    "disturbed-ticket",
    "useful-crack",
    "delicate-birds",
    "squealing-toad",
    "descriptive-pies",
    "obsequious-lake",
    "blue-passenger",
    "addicted-galley",
    "curly-cars",
    "optimal-stone",
    "omniscient-reaction",
    "alcoholic-baseball",
    "faded-structure",
    "coordinated-dinner",
    "deserted-plants",
    "abundant-paper",
    "whimsical-houses",
    "spiffy-chairs",
    "future-invention",
    "irritating-thing",
    "panoramic-tiger",
    "unbiased-twist",
    "animated-industry",
    "jazzy-fruit",
    "symptomatic-nut",
    "afraid-destruction",
    "agreeable-advertisement",
    "secretive-rod",
    "brief-burst",
    "clumsy-downtown",
    "ill-fated-sock",
    "precious-pizzas",
    "early-umbrella",
    "hilarious-oven",
    "useful-amount",
    "hot-week",
    "stormy-word",
    "acid-list",
    "tender-fly",
    "superb-desire",
    "laughable-badge",
    "gusty-toy",
    "slippery-distribution",
    "abortive-legs",
    "animated-wall",
    "hilarious-bead",
    "four-ornament",
    "right-rhythm",
    "caring-color",
    "flat-popcorn",
    "quizzical-sun",
    "different-sheep",
    "wicked-oatmeal",
    "one-help",
    "vagabond-stem",
    "damp-beam",
    "plausible-tongue",
    "lean-pain",
    "juvenile-pipe",
    "general-idea",
    "thoughtless-pen",
    "large-cloud",
    "illegal-airplane",
    "enchanted-star",
    "short-thrill",
    "skillful-earth",
    "future-science",
    "futuristic-rabbits",
    "zealous-doll",
    "crowded-week",
    "fascinated-recess",
    "wide-quilt",
    "various-cobweb",
    "mighty-pipe",
    "deep-volleyball",
    "sneaky-blood",
    "damaging-mailbox",
    "rambunctious-anger",
    "crowded-morning",
    "excited-knife",
    "lumpy-throat",
    "wakeful-hand",
    "longing-letters",
];
